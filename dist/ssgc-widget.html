<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="robots" content="noindex,nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SSGC Widget</title>
<style>
  :root { --brand: #2f6fef; }
  body { 
    margin: 0; 
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; 
    background: #fff;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header { 
    padding: 10px 12px; 
    background: var(--brand); 
    color: #fff; 
    font-weight: 600; 
    font-size: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  #msgs { 
    padding: 12px; 
    flex: 1;
    overflow-y: auto; 
    overflow-x: hidden;
    scroll-behavior: smooth;
  }
  .m { 
    margin: 8px 0; 
    line-height: 1.4; 
    word-wrap: break-word;
    font-size: 14px;
  }
  .me { 
    text-align: right; 
  }
  .me .bubble {
    background: var(--brand);
    color: #fff;
    display: inline-block;
    padding: 8px 12px;
    border-radius: 12px 12px 4px 12px;
    max-width: 80%;
  }
  .bot .bubble {
    background: #f1f3f4;
    color: #333;
    display: inline-block;
    padding: 8px 12px;
    border-radius: 12px 12px 12px 4px;
    max-width: 80%;
  }
  .cite { 
    font-size: 12px; 
    opacity: 0.75; 
    margin-top: 6px; 
    padding-left: 12px;
  }
  .cite a {
    color: var(--brand);
    text-decoration: none;
  }
  .cite a:hover {
    text-decoration: underline;
  }
  form { 
    display: flex; 
    gap: 8px; 
    padding: 10px; 
    border-top: 1px solid #eee; 
    background: #fff;
  }
  input { 
    flex: 1; 
    padding: 10px; 
    border: 1px solid #ddd; 
    border-radius: 8px; 
    font-size: 14px;
    outline: none;
  }
  input:focus {
    border-color: var(--brand);
    box-shadow: 0 0 0 2px rgba(47, 111, 239, 0.1);
  }
  button { 
    padding: 10px 14px; 
    border: 0; 
    border-radius: 8px; 
    background: var(--brand); 
    color: #fff; 
    font-weight: 600; 
    cursor: pointer; 
    font-size: 14px;
    transition: background-color 0.2s;
  }
  button:hover {
    background: #1e5bb8;
  }
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .thinking {
    opacity: 0.7;
    font-style: italic;
  }
  .error {
    color: #d63638;
  }
  .welcome {
    text-align: center;
    color: #666;
    font-size: 13px;
    margin: 20px 0;
    padding: 0 20px;
  }
</style>
</head>
<body>
  <header>Smart Search Chatbot</header>
  <div id="msgs">
    <div class="welcome">
      ðŸ‘‹ Hi! I'm here to help you find information. Ask me anything about this site.
    </div>
  </div>
  <form id="f">
    <input id="q" placeholder="Ask me anythingâ€¦" autocomplete="off">
    <button type="submit" id="send-btn">Send</button>
  </form>

<script>
(function(){
  // Read config from parent via query + global
  var cfg = parent.SSGC_WIDGET || {};
  if (cfg.themeColor) {
    document.documentElement.style.setProperty('--brand', cfg.themeColor);
  }

  var sid = new URLSearchParams(location.search).get('sid') || '';
  var chat = cfg.chatUrl; // absolute rest url localized in PHP
  var msgs = document.getElementById('msgs');
  var f = document.getElementById('f');
  var q = document.getElementById('q');
  var sendBtn = document.getElementById('send-btn');

  // Focus input on load
  q.focus();

  function addMessage(text, isUser, isError) {
    var div = document.createElement('div');
    div.className = 'm ' + (isUser ? 'me' : 'bot') + (isError ? ' error' : '');
    
    var bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    
    div.appendChild(bubble);
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    
    return div;
  }

  function addCitations(cites) {
    if (!cites || !cites.length) return;
    var div = document.createElement('div');
    div.className = 'cite';
    div.innerHTML = 'Sources: ' + cites.map(function(c) {
      return '<a href="' + c.url + '" target="_blank" rel="noopener">' + (c.title || c.url) + '</a>';
    }).join(' â€¢ ');
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function setLoading(loading) {
    sendBtn.disabled = loading;
    sendBtn.textContent = loading ? 'Sending...' : 'Send';
    q.disabled = loading;
  }

  f.addEventListener('submit', async function(e) {
    e.preventDefault();
    var prompt = q.value.trim();
    if (!prompt) return;
    
    // Add user message
    addMessage(prompt, true);
    q.value = '';
    
    // Add thinking indicator
    var thinkingMsg = addMessage('Thinking...', false);
    thinkingMsg.classList.add('thinking');
    
    setLoading(true);

    try {
      var res = await fetch(chat, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          prompt: prompt, 
          session_id: sid 
        })
      });
      
      var data = await res.json();
      
      // Remove thinking message
      msgs.removeChild(thinkingMsg);
      
      if (!res.ok || data.error) {
        var errorMsg = data.error || res.statusText;
        if (data.detail) {
          errorMsg += ': ' + data.detail;
        }
        addMessage('Error: ' + errorMsg, false, true);
        return;
      }
      
      // Add bot response
      addMessage(data.text || '(no answer)', false);
      
      // Add citations if present
      addCitations(data.citations);
      
    } catch (err) {
      // Remove thinking message
      if (thinkingMsg.parentNode) {
        msgs.removeChild(thinkingMsg);
      }
      addMessage('Network error: ' + err.message, false, true);
    } finally {
      setLoading(false);
      q.focus();
    }
  });

  // Handle Enter key
  q.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      f.dispatchEvent(new Event('submit'));
    }
  });

  // Send message to parent about ready state
  if (parent !== window) {
    parent.postMessage({
      type: 'ssgc:ready'
    }, '*');
  }

})();
</script>
</body>
</html>
