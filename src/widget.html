<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Search Chatbot Widget</title>
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      color: #333;
      background: #fff;
      height: 100vh;
      overflow: hidden;
    }

    /* Widget container */
    .ssgc-widget {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #fff;
    }

    /* Header */
    .ssgc-header {
      background: #007cba;
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #0066a0;
      flex-shrink: 0;
    }

    .ssgc-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .ssgc-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .ssgc-close:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .ssgc-close svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* Messages area */
    .ssgc-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
    }

    .ssgc-message {
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .ssgc-message.user {
      flex-direction: row-reverse;
    }

    .ssgc-message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 12px;
      font-weight: 600;
    }

    .ssgc-message.user .ssgc-message-avatar {
      background: #007cba;
      color: white;
    }

    .ssgc-message.bot .ssgc-message-avatar {
      background: #6c757d;
      color: white;
    }

    .ssgc-message-content {
      background: white;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      max-width: 80%;
      word-wrap: break-word;
    }

    .ssgc-message.user .ssgc-message-content {
      background: #007cba;
      color: white;
    }

    .ssgc-message-text {
      margin: 0;
      line-height: 1.4;
    }

    /* Citations */
    .ssgc-citations {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e9ecef;
    }

    .ssgc-citations-title {
      font-size: 12px;
      font-weight: 600;
      color: #6c757d;
      margin-bottom: 8px;
    }

    .ssgc-citation {
      display: block;
      color: #007cba;
      text-decoration: none;
      font-size: 12px;
      margin-bottom: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      background: #f8f9fa;
      transition: background-color 0.2s;
    }

    .ssgc-citation:hover {
      background: #e9ecef;
      text-decoration: underline;
    }

    /* Input area */
    .ssgc-input-area {
      padding: 16px 20px;
      background: white;
      border-top: 1px solid #e9ecef;
      flex-shrink: 0;
    }

    .ssgc-input-form {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .ssgc-input {
      flex: 1;
      border: 1px solid #ced4da;
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      outline: none;
      transition: border-color 0.2s;
    }

    .ssgc-input:focus {
      border-color: #007cba;
      box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.1);
    }

    .ssgc-send-btn {
      background: #007cba;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background-color 0.2s;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 60px;
    }

    .ssgc-send-btn:hover:not(:disabled) {
      background: #0066a0;
    }

    .ssgc-send-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    /* Loading indicator */
    .ssgc-loading {
      display: none;
      align-items: center;
      gap: 8px;
      color: #6c757d;
      font-size: 12px;
      padding: 8px 16px;
    }

    .ssgc-loading.active {
      display: flex;
    }

    .ssgc-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e9ecef;
      border-top: 2px solid #007cba;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Welcome message */
    .ssgc-welcome {
      text-align: center;
      color: #6c757d;
      padding: 40px 20px;
      font-size: 14px;
    }

    .ssgc-welcome h3 {
      margin-bottom: 8px;
      color: #333;
    }

    /* Scrollbar styling */
    .ssgc-messages::-webkit-scrollbar {
      width: 6px;
    }

    .ssgc-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .ssgc-messages::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    .ssgc-messages::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>
  <div class="ssgc-widget">
    <!-- Header -->
    <div class="ssgc-header">
      <h2 class="ssgc-title">Smart Search Chat</h2>
      <button class="ssgc-close" aria-label="Close chat" onclick="closeWidget()">
        <svg viewBox="0 0 24 24">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <!-- Messages area -->
    <div class="ssgc-messages" id="messages">
      <div class="ssgc-welcome">
        <h3>Welcome to Smart Search Chat</h3>
        <p>Ask me anything and I'll help you find the information you need.</p>
      </div>
    </div>

    <!-- Loading indicator -->
    <div class="ssgc-loading" id="loading">
      <div class="ssgc-spinner"></div>
      <span>Thinking...</span>
    </div>

    <!-- Input area -->
    <div class="ssgc-input-area">
      <form class="ssgc-input-form" onsubmit="sendMessage(event)">
        <textarea 
          class="ssgc-input" 
          id="messageInput" 
          placeholder="Type your message..."
          rows="1"
          onkeydown="handleInputKeydown(event)"
        ></textarea>
        <button type="submit" class="ssgc-send-btn" id="sendBtn">Send</button>
      </form>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      // Configuration and state
      let config = null;
      let sessionId = null;
      let isLoading = false;
      let chatEndpoint = null;

      // DOM elements
      const messagesEl = document.getElementById('messages');
      const loadingEl = document.getElementById('loading');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');

      // Initialize widget
      function init() {
        // Get session ID from URL params
        const urlParams = new URLSearchParams(window.location.search);
        sessionId = urlParams.get('sid');

        // Auto-resize textarea
        messageInput.addEventListener('input', autoResizeTextarea);

        // Notify parent that widget is ready
        window.parent.postMessage({ type: 'ssgc:ready' }, '*');

        // Listen for configuration from parent
        window.addEventListener('message', handleParentMessage);
      }

      // Handle messages from parent window
      function handleParentMessage(event) {
        const { type, data } = event.data;

        if (type === 'ssgc:config') {
          config = data.config;
          sessionId = data.sessionId;

          // Set chat endpoint
          if (data.configUrl) {
            const url = new URL(data.configUrl);
            chatEndpoint = `${url.origin}/wp-json/ssgc/v1/chat`;
          }

          // Update UI with config
          if (config) {
            updateUIFromConfig();
          }
        }
      }

      // Update UI based on configuration
      function updateUIFromConfig() {
        if (!config) return;

        // Update title
        if (config.title) {
          document.querySelector('.ssgc-title').textContent = config.title;
        }

        // Update colors
        if (config.color) {
          const headerEl = document.querySelector('.ssgc-header');
          const sendBtnEl = document.querySelector('.ssgc-send-btn');
          headerEl.style.background = config.color;
          sendBtnEl.style.background = config.color;
        }

        // Update welcome message
        if (config.welcomeMessage) {
          const welcomeEl = document.querySelector('.ssgc-welcome p');
          welcomeEl.textContent = config.welcomeMessage;
        }
      }

      // Auto-resize textarea
      function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      }

      // Handle input keydown
      function handleInputKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendMessage(event);
        }
      }

      // Send message
      async function sendMessage(event) {
        event.preventDefault();

        const message = messageInput.value.trim();
        if (!message || isLoading) return;

        // Add user message to chat
        addMessage('user', message);

        // Clear input
        messageInput.value = '';
        autoResizeTextarea();

        // Show loading
        setLoading(true);

        try {
          // Send to chat endpoint
          const response = await fetch(chatEndpoint || '/wp-json/ssgc/v1/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              prompt: message,
              session_id: sessionId
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          // Hide loading
          setLoading(false);

          if (data.error) {
            addMessage('bot', `Sorry, I encountered an error: ${data.error}`);
          } else {
            addMessage('bot', data.text, data.citations);
          }

        } catch (error) {
          setLoading(false);
          console.error('Chat error:', error);
          addMessage('bot', 'Sorry, I\'m having trouble connecting right now. Please try again later.');
        }
      }

      // Add message to chat
      function addMessage(sender, text, citations = null) {
        // Remove welcome message if it exists
        const welcomeEl = document.querySelector('.ssgc-welcome');
        if (welcomeEl) {
          welcomeEl.remove();
        }

        const messageEl = document.createElement('div');
        messageEl.className = `ssgc-message ${sender}`;

        const avatarEl = document.createElement('div');
        avatarEl.className = 'ssgc-message-avatar';
        avatarEl.textContent = sender === 'user' ? 'U' : 'AI';

        const contentEl = document.createElement('div');
        contentEl.className = 'ssgc-message-content';

        const textEl = document.createElement('p');
        textEl.className = 'ssgc-message-text';
        textEl.textContent = text;
        contentEl.appendChild(textEl);

        // Add citations if present
        if (citations && citations.length > 0) {
          const citationsEl = document.createElement('div');
          citationsEl.className = 'ssgc-citations';

          const titleEl = document.createElement('div');
          titleEl.className = 'ssgc-citations-title';
          titleEl.textContent = 'Sources:';
          citationsEl.appendChild(titleEl);

          citations.forEach(citation => {
            const linkEl = document.createElement('a');
            linkEl.className = 'ssgc-citation';
            linkEl.href = citation.url;
            linkEl.target = '_blank';
            linkEl.rel = 'noopener noreferrer';
            linkEl.textContent = citation.title;
            citationsEl.appendChild(linkEl);
          });

          contentEl.appendChild(citationsEl);
        }

        messageEl.appendChild(avatarEl);
        messageEl.appendChild(contentEl);
        messagesEl.appendChild(messageEl);

        // Scroll to bottom
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      // Set loading state
      function setLoading(loading) {
        isLoading = loading;
        loadingEl.classList.toggle('active', loading);
        sendBtn.disabled = loading;
        messageInput.disabled = loading;

        if (loading) {
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
      }

      // Close widget
      window.closeWidget = function() {
        window.parent.postMessage({ type: 'ssgc:close' }, '*');
      };

      // Global functions for HTML event handlers
      window.sendMessage = sendMessage;
      window.handleInputKeydown = handleInputKeydown;

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

    })();
  </script>
</body>
</html>
